name: ðŸ›¡ï¸ AutoPatch-Bot Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ðŸ” Run AutoPatch-Bot Scanner
        id: scan
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python scanner.py . --output json -o scan_results.json || true
          
          # Parse results
          if [ -f scan_results.json ]; then
            TOTAL=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['summary']['total_issues'])")
            CRITICAL=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['summary']['by_severity']['critical'])")
            HIGH=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['summary']['by_severity']['high'])")
            GRADE=$(python -c "import json; data=json.load(open('scan_results.json')); print(data['summary']['security_grade'])")
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "grade=$GRADE" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "grade=A" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“ Generate Report
        run: |
          python scanner.py . --output html -o security_report.html || true

      - name: ðŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let scanData = { summary: { total_issues: 0, by_severity: { critical: 0, high: 0, medium: 0 }, security_grade: 'A' }, issues: [] };
            
            try {
              scanData = JSON.parse(fs.readFileSync('scan_results.json', 'utf8'));
            } catch (e) {
              console.log('No scan results found');
            }
            
            const total = scanData.summary.total_issues;
            const critical = scanData.summary.by_severity.critical;
            const high = scanData.summary.by_severity.high;
            const medium = scanData.summary.by_severity.medium;
            const grade = scanData.summary.security_grade;
            
            let badge = 'âœ… **No vulnerabilities detected!**';
            if (critical > 0) {
              badge = 'ðŸ”´ **CRITICAL ISSUES FOUND**';
            } else if (high > 0) {
              badge = 'ðŸŸ  **High severity issues found**';
            } else if (total > 0) {
              badge = 'ðŸŸ¡ **Medium/Low issues found**';
            }
            
            let issuesList = '';
            if (scanData.issues && scanData.issues.length > 0) {
              issuesList = '\n\n### Vulnerabilities Found\n\n';
              scanData.issues.slice(0, 10).forEach((issue, i) => {
                const icon = issue.severity === 'CRITICAL' ? 'ðŸ”´' : issue.severity === 'HIGH' ? 'ðŸŸ ' : 'ðŸŸ¡';
                issuesList += `\n<details>\n<summary>${icon} <b>${issue.type}</b> in <code>${issue.file.split('/').pop()}</code> (Line ${issue.line})</summary>\n\n`;
                issuesList += `**Severity:** ${issue.severity}\n\n`;
                issuesList += `**Vulnerable Code:**\n\`\`\`\n${issue.vulnerable_code || 'N/A'}\n\`\`\`\n\n`;
                issuesList += `**Explanation:** ${issue.explanation || 'N/A'}\n\n`;
                if (issue.fixed_code && !issue.fixed_code.includes('AI mode')) {
                  issuesList += `**Suggested Fix:**\n\`\`\`\n${issue.fixed_code}\n\`\`\`\n`;
                }
                issuesList += '\n</details>\n';
              });
              
              if (scanData.issues.length > 10) {
                issuesList += `\n*... and ${scanData.issues.length - 10} more issues*\n`;
              }
            }
            
            const comment = `## ðŸ›¡ï¸ AutoPatch-Bot Security Scan

${badge}

### Summary
| Metric | Value |
|--------|-------|
| Security Grade | **${grade}** |
| ðŸ”´ Critical | ${critical} |
| ðŸŸ  High | ${high} |
| ðŸŸ¡ Medium | ${medium} |
| **Total Issues** | **${total}** |
${issuesList}

---
*Powered by AutoPatch-Bot - AI Security Scanner*
`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => c.body.includes('AutoPatch-Bot Security Scan'));
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: âŒ Fail if Critical Issues
        if: steps.scan.outputs.critical > 0
        run: |
          echo "::error::Critical security vulnerabilities found! Please fix before merging."
          exit 1

      - name: âš ï¸ Warn if High Issues
        if: steps.scan.outputs.critical == 0 && steps.scan.outputs.high > 0
        run: |
          echo "::warning::High severity vulnerabilities found. Please review."

      - name: âœ… Pass if Secure
        if: steps.scan.outputs.critical == 0 && steps.scan.outputs.high == 0
        run: |
          echo "âœ… No critical or high severity issues found!"
